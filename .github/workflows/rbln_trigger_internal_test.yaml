name: CI / Trigger internal test

on:
  workflow_call:
    inputs:
      ref:
        description: "ref to checkout"
        required: false
        type: string
      rebel_compiler_version:
        description: "Version of rebel-compiler to use (optional)"
        required: false
        type: string
      optimum_rbln_version:
        description: "Version of optimum-rbln to use (optional)"
        required: false
        type: string

jobs:
  get-compiler-version:
    if: ${{ !inputs.rebel_compiler_version }}
    uses: ./.github/workflows/rbln_utils_get_compiler_version_ci.yaml
    secrets: inherit

  build-vllm-rbln:
    name: Build vllm-rbln wheel
    runs-on: rbln-sw-k8s-general
    outputs:
      wheel_filename: ${{ steps.get_wheel_filename.outputs.WHEEL_FILENAME }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.pr_number && format('refs/pull/{0}/merge', inputs.pr_number) || inputs.ref || github.sha }}
          fetch-depth: 0

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install build dependencies and build vllm-rbln wheel
        run: |
          python -m pip install build setuptools_scm
          python -m build --wheel

      - name: Get wheel filename
        id: get_wheel_filename
        run: |
          WHEEL_FILENAME=$(ls dist/vllm_rbln-*.whl | xargs basename)
          echo "Found wheel file: ${WHEEL_FILENAME}"
          echo "WHEEL_FILENAME=${WHEEL_FILENAME}" >> $GITHUB_OUTPUT
      
      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: vllm-wheel
          path: dist/
          retention-days: 7

  vllm-rbln-pytest:
    needs: [get-compiler-version, build-vllm-rbln]
    uses: ./.github/workflows/rbln_vllm-rbln_pytest.yaml
    secrets: inherit
    with:
      ref: ${{ inputs.ref }}
      rebel_compiler_version: ${{ needs.get-compiler-version.outputs.compiler_version }}
      optimum_rbln_version: ${{ inputs.optimum_rbln_version }}

  vllm-rbln-optimum-ci:
    needs: [get-compiler-version, build-vllm-rbln]
    uses: ./.github/workflows/rbln_optimum_ci.yaml
    secrets: inherit
    with:
      ref: ${{ inputs.ref }}
      rebel_compiler_version: ${{ needs.get-compiler-version.outputs.compiler_version }}
      optimum_rbln_version: ${{ inputs.optimum_rbln_version }}
