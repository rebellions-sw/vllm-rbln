name: CI / Utils / Get optimum-rbln version

on:
  workflow_call:
    outputs:
      optimum_version:
        description: "optimum-rbln package version"
        value: ${{ jobs.get-optimum-version.outputs.optimum_version }}

jobs:
  get-optimum-version:
    runs-on: ubuntu-latest-rbln
    outputs:
      optimum_version: ${{ steps.get_target_optimum_version.outputs.OPTIMUM_RBLN_VERSION }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get optimum version from requirements.txt
        id: get_target_optimum_version
        run: |
          OPTIMUM_RBLN_LINE=$(grep -E '^optimum-rbln|optimum-rbln.git' requirements.txt)
          if [[ "$OPTIMUM_RBLN_LINE" =~ ^optimum-rbln[[:space:]]*@[[:space:]] ]]; then
            REF="${OPTIMUM_RBLN_LINE##*@}"
            OPTIMUM_RBLN_VERSION="${REF%%[#[:space:]]*}"

          elif [[ "$OPTIMUM_RBLN_LINE" =~ ^git\+ ]]; then
            REF="${OPTIMUM_RBLN_LINE##*@}"
            OPTIMUM_RBLN_VERSION="${REF%%[#[:space:]]*}"

          elif [[ "$OPTIMUM_RBLN_LINE" =~ ^optimum-rbln[[:space:]]*== ]]; then
            OPTIMUM_RBLN_VERSION="$(echo "$OPTIMUM_RBLN_LINE" | sed -E 's/^optimum-rbln[[:space:]]*==[[:space:]]*//')"

          elif [[ "$OPTIMUM_RBLN_LINE" =~ ^optimum-rbln[[:space:]]*>[=] ]]; then
            OPTIMUM_RBLN_VERSION="$(echo "$OPTIMUM_RBLN_LINE" | sed -E 's/^optimum-rbln[[:space:]]*>=[[:space:]]*//')"

          else
            echo "Unrecognized optimum-rbln spec: $OPTIMUM_RBLN_LINE" >&2
            exit 1
          fi
          echo "Found optimum-rbln version in requirements.txt: $OPTIMUM_RBLN_VERSION"
          echo "OPTIMUM_RBLN_VERSION=$OPTIMUM_RBLN_VERSION" >> $GITHUB_OUTPUT
